<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººè„¸è¯†åˆ«ä¸æ‰“ç ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #666; text-align: center; margin-bottom: 30px; }
        .upload-area {
            border: 3px dashed #ccc;
            padding: 50px 20px;
            text-align: center;
            margin: 30px 0;
            border-radius: 10px;
            cursor: pointer;
            background: #fafafa;
            transition: all 0.3s;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #4CAF50;
            background: #f0f9f0;
        }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        button:hover { background: #45a049; }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .image-grid {
            display: none; /* åˆå§‹éšè—ï¼Œä¸Šä¼ æˆåŠŸåæ‰æ˜¾ç¤º */
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }
        .image-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            border: 1px solid #eee;
        }
        .image-header {
            background: #f7f7f7;
            padding: 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        .image-header h4 {
            color: #333;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .image-container {
            padding: 20px;
            text-align: center;
        }
        .image-container img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 5px;
            display: block;
            margin: 0 auto;
        }
        .result-info {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
            text-align: center;
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px;
            color: #666;
        }
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        #resetBtn { background: #6c757d; }
        #resetBtn:hover { background: #5a6268; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤– äººè„¸è¯†åˆ«ä¸æ‰“ç ç³»ç»Ÿ</h1>
            <p class="subtitle">ä¸Šä¼ å›¾ç‰‡ï¼Œè‡ªåŠ¨æ£€æµ‹äººè„¸å¹¶ç”Ÿæˆæ‰“ç ä¿æŠ¤å›¾</p>
        </header>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area" id="dropArea">
            <div class="upload-icon">ğŸ“</div>
            <h3>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤åŒºåŸŸ</h3>
            <p>æ”¯æŒ JPG, PNG, GIF, BMP æ ¼å¼ï¼Œæœ€å¤§ 16MB</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div style="text-align: center;">
            <button id="uploadBtn" disabled>ğŸš€ å¼€å§‹æ£€æµ‹ä¸æ‰“ç </button>
            <button id="resetBtn" disabled>ğŸ”„ é‡ç½®</button>
        </div>

        <!-- åŠ è½½æç¤º -->
        <div class="loading" id="loading">æ­£åœ¨å¤„ç†å›¾ç‰‡</div>

        <!-- æ£€æµ‹ç»“æœç»Ÿè®¡ -->
        <div class="result-info" id="resultInfo">
            <h3>ğŸ¯ æ£€æµ‹å®Œæˆ</h3>
            <p>å…±è¯†åˆ«åˆ° <strong id="faceCount">0</strong> å¼ äººè„¸</p>
            <p><small>å¤„ç†æ—¶é—´: <span id="processTime">0</span> ç§’ | <span id="timestamp">-</span></small></p>
        </div>

        <!-- ä¸‰å›¾å¯¹æ¯”å±•ç¤ºåŒº -->
        <div class="image-grid" id="imageGrid">
            <!-- åŸå§‹å›¾ç‰‡ -->
            <div class="image-card">
                <div class="image-header"><h4><span>ğŸ–¼ï¸</span> åŸå§‹å›¾ç‰‡</h4></div>
                <div class="image-container"><img id="originalImage" alt="åŸå§‹å›¾ç‰‡"></div>
            </div>
            
            <!-- å¸¦æ¡†æ ‡è®°å›¾ -->
            <div class="image-card">
                <div class="image-header"><h4><span>âœ…</span> äººè„¸æ ‡è®°å›¾</h4></div>
                <div class="image-container"><img id="markedImage" alt="äººè„¸æ ‡è®°å›¾"></div>
            </div>
            
            <!-- äººè„¸æ‰“ç å›¾ -->
            <div class="image-card">
                <div class="image-header"><h4><span>ğŸ”’</span> äººè„¸æ‰“ç å›¾</h4></div>
                <div class="image-container"><img id="blurredImage" alt="äººè„¸æ‰“ç å›¾"></div>
            </div>
        </div>

        <footer style="text-align: center; margin-top: 40px; color: #888; font-size: 0.9rem;">
            <p>åŸºäº Flask + OpenCV æ„å»º | äººè„¸æ£€æµ‹ä¸éšç§ä¿æŠ¤å·¥å…·</p>
        </footer>
    </div>

    <script>
        // DOM å…ƒç´ 
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const loading = document.getElementById('loading');
        const resultInfo = document.getElementById('resultInfo');
        const imageGrid = document.getElementById('imageGrid');
        
        // ä¸‰ä¸ªç»“æœå›¾ç‰‡å…ƒç´ 
        const originalImage = document.getElementById('originalImage');
        const markedImage = document.getElementById('markedImage');
        const blurredImage = document.getElementById('blurredImage');
        
        // ç»Ÿè®¡ä¿¡æ¯å…ƒç´ 
        const faceCountEl = document.getElementById('faceCount');
        const processTimeEl = document.getElementById('processTime');
        const timestampEl = document.getElementById('timestamp');
        
        let selectedFile = null;
        let processStartTime = null;

        // ==================== äº‹ä»¶ç›‘å¬ ====================
        
        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
        dropArea.addEventListener('click', () => fileInput.click());
        
        // æ–‡ä»¶é€‰æ‹©å˜åŒ–
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                previewFile(selectedFile);
                uploadBtn.disabled = false;
            }
        });
        
        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                selectedFile = e.dataTransfer.files[0];
                previewFile(selectedFile);
                uploadBtn.disabled = false;
            }
        });
        
        // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        uploadBtn.addEventListener('click', handleUpload);
        
        // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        resetBtn.addEventListener('click', resetAll);

        // ==================== æ ¸å¿ƒå‡½æ•° ====================
        
        // é¢„è§ˆå›¾ç‰‡
        function previewFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                // åœ¨åŸå§‹å›¾ç‰‡ä½ç½®é¢„è§ˆ
                originalImage.src = e.target.result;
                // å…ˆéšè—å…¶ä»–ç»“æœï¼Œåªæ˜¾ç¤ºåŸå§‹å›¾é¢„è§ˆ
                imageGrid.style.display = 'grid';
                resultInfo.style.display = 'none';
                resetBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }
        
        // å¤„ç†ä¸Šä¼ 
        async function handleUpload() {
            if (!selectedFile) return;
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            // æ˜¾ç¤ºåŠ è½½ï¼Œç¦ç”¨æŒ‰é’®
            loading.style.display = 'block';
            uploadBtn.disabled = true;
            resetBtn.disabled = true;
            processStartTime = Date.now();
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // è®¡ç®—å¤„ç†æ—¶é—´
                const processTime = ((Date.now() - processStartTime) / 1000).toFixed(2);
                
                if (data.success) {
                    // 1. æ›´æ–°ç»“æœä¿¡æ¯
                    faceCountEl.textContent = data.face_count;
                    processTimeEl.textContent = processTime;
                    timestampEl.textContent = data.timestamp || new Date().toLocaleTimeString();
                    
                    // 2. æ˜¾ç¤ºä¸‰å¼ ç»“æœå›¾ç‰‡ï¼ˆé˜²æ­¢ç¼“å­˜ï¼‰
                    originalImage.src = data.original_url + '?t=' + Date.now();
markedImage.src = `data:image/jpeg;base64,${data.marked_image}`;
blurredImage.src = `data:image/jpeg;base64,${data.blurred_image}`;
                    
                    // 3. æ˜¾ç¤ºç»“æœåŒºåŸŸ
                    resultInfo.style.display = 'block';
                    imageGrid.style.display = 'grid';
                    
                    // 4. æ˜¾ç¤ºé€šçŸ¥
                    if (data.face_count > 0) {
                        alert(`âœ… æˆåŠŸæ£€æµ‹åˆ° ${data.face_count} å¼ äººè„¸ï¼\nå·²ç”Ÿæˆæ ‡è®°å›¾å’Œæ‰“ç å›¾ã€‚`);
                    } else {
                        alert('âš ï¸ æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·å°è¯•æ›´æ¢å›¾ç‰‡ã€‚');
                    }
                } else {
                    alert(`âŒ å¤„ç†å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                    // å‡ºé”™æ—¶ä»æ˜¾ç¤ºå·²ä¸Šä¼ çš„åŸå§‹å›¾ç‰‡é¢„è§ˆ
                    imageGrid.style.display = 'grid';
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥ã€‚');
            } finally {
                // æ¢å¤ç•Œé¢çŠ¶æ€
                loading.style.display = 'none';
                uploadBtn.disabled = false;
                resetBtn.disabled = false;
            }
        }
        
        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        function resetAll() {
            selectedFile = null;
            fileInput.value = '';
            
            // æ¸…ç©ºå›¾ç‰‡æ˜¾ç¤º
            originalImage.src = '';
            markedImage.src = '';
            blurredImage.src = '';
            
            // éšè—ç»“æœåŒºåŸŸ
            imageGrid.style.display = 'none';
            resultInfo.style.display = 'none';
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            uploadBtn.disabled = true;
            resetBtn.disabled = true;
            
            console.log('ç³»ç»Ÿå·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°ä¸Šä¼ å›¾ç‰‡ã€‚');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.addEventListener('DOMContentLoaded', () => {
            console.log('äººè„¸è¯†åˆ«ä¸æ‰“ç ç³»ç»Ÿå‰ç«¯å·²åŠ è½½ã€‚');
            console.log('æç¤ºï¼šè¯·ç¡®ä¿åç«¯ Flask æœåŠ¡æ­£åœ¨è¿è¡Œ (python app.py)');
        });
    </script>
</body>
</html>